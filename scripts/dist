#! /bin/bash
#
# This file is part of DisOrder
# Copyright (C) 2005-2008 Richard Kettlewell
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

set -e
web=$HOME/public_html/web/disorder

make
make distcheck
make dist-bzip2
d=$(make echo-distdir)
src=$d.tar.bz2

# Report and execute a command remotely
remote() {
  local h=$1
  shift
  echo "$h:" "$@"
  ssh $h "$@"
}

# Build .debs and copy to the right place
build() {
  local h=$1			# build host
  local f=$2

  remote $h "mkdir -p _builds"
  remote $h "rm -rf _builds/*.deb _builds/$d"
  scp $src $h:_builds
  remote $h "cd _builds && tar xfj $src"
  remote $h "cd _builds/$d && fakeroot debian/rules binary"
  mkdir -p $web/$f
  scp $h:_builds/*.deb $web/$f/.
}

# Build various debs

# Ubuntu dapper; binaries suit Debian etch too
build dekabrach etch

# Debian lenny (32-bit)
build leucomorph lenny

# Debian lenny (64-bit)
build araminta lenny  

# Update the web
cp $src $web
cd doc
for f in *.[1-9].html; do
  echo $f
  rm -f $web/$f
  sed < $f > $web/$f 's/^@.*//'
done
cp plumbing.svg $web/.
if [ -f plumbing.png ]; then
  cp plumbing.png $web/.
fi

